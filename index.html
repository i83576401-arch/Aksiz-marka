<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8" />
    <title>Aksiz markalari – bojxona portali (localStorage demo)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        :root {
            --bg-gradient-top: #0f172a;
            --bg-gradient-bottom: #1f2937;
            --card-bg: #ffffff;
            --accent: #2563eb;
            --accent-soft: #dbeafe;
            --accent-strong: #1d4ed8;
            --text-main: #0f172a;
            --text-muted: #6b7280;
            --border-subtle: #e5e7eb;
            --danger: #b91c1c;
            --success: #166534;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top left, #111827, #020617 60%);
            color: var(--text-main);
        }

        .hidden { display: none !important; }

        .layout {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: linear-gradient(90deg, #0f172a, #1d4ed8);
            color: #e5e7eb;
            box-shadow: 0 1px 4px rgba(0,0,0,0.25);
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-circle {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            background: rgba(15,23,42,0.85);
            display:flex;
            align-items:center;
            justify-content:center;
            overflow: hidden;
        }

        .logo-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .logo-fallback {
            font-size: 18px;
            font-weight: 700;
        }

        .topbar-title {
            display:flex;
            flex-direction:column;
        }

        .topbar-title span:first-child {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .topbar-title span:last-child {
            font-size: 13px;
            opacity: 0.85;
        }

        .topbar-right {
            font-size: 12px;
            text-align:right;
        }

        .topbar-role {
            font-weight: 600;
        }

        .wrapper {
            max-width: 1180px;
            width: 100%;
            margin: 0 auto;
            padding: 18px 12px 40px;
        }

        .grid-main {
            display:grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
            gap: 16px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px 18px;
            border: 1px solid rgba(148,163,184,0.35);
            box-shadow:
                0 16px 40px rgba(15,23,42,0.30),
                0 0 0 1px rgba(148,163,184,0.30);
            margin-bottom: 16px;
        }

        .card-soft {
            border-radius: 16px;
            padding: 14px 16px;
            border: 1px solid rgba(148,163,184,0.25);
            background: radial-gradient(circle at top left, #eff6ff, #ffffff);
        }

        h1, h2, h3, h4 {
            margin: 4px 0 8px;
        }

        h1 { font-size: 22px; }
        h2 { font-size: 18px; }
        h3 { font-size: 15px; }
        h4 { font-size: 14px; }

        .muted {
            font-size: 13px;
            color: var(--text-muted);
        }

        label {
            display: block;
            font-size: 12px;
            margin-bottom: 3px;
            color: #374151;
        }

        input, select, textarea {
            width: 100%;
            padding: 7px 8px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            font-size: 13px;
            background:#f9fafb;
        }

        textarea {
            min-height: 70px;
            resize: vertical;
        }

        input:focus, select:focus, textarea:focus {
            outline: 2px solid var(--accent-soft);
            border-color: var(--accent);
            background:#ffffff;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .col-2 {
            flex: 1 1 220px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 7px 14px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--accent-strong);
        }

        .btn-ghost {
            background: transparent;
            color: #111827;
        }

        .btn-ghost:hover {
            background:#e5e7eb;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12.5px;
        }
        th, td {
            padding: 7px 6px;
            border-bottom: 1px solid var(--border-subtle);
            text-align: left;
        }
        th {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
        }
        tr:nth-child(even) td {
            background:#f9fafb;
        }
        tr:hover td {
            background: #eff6ff;
        }

        .badge {
            padding: 2px 7px;
            border-radius: 999px;
            font-size: 11px;
            display: inline-block;
        }
        .badge-new { background:#e0f2fe; color:#0369a1; }
        .badge-review { background:#e5e7eb; color:#374151; }
        .badge-approved { background:#dcfce7; color:#166534; }
        .badge-rejected { background:#fee2e2; color:#b91c1c; }
        .badge-bank { background:#fef3c7; color:#92400e; }

        .error-msg { color:var(--danger); font-size:12px; margin-left:8px; }
        .ok-msg { color:var(--success); font-size:12px; margin-left:8px; }

        .section-title {
            margin-top: 10px;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color:#1f2937;
        }

        /* LOGIN CARD markazda */
        #login-card {
            max-width: 520px;
            margin: 40px auto;
            background: radial-gradient(circle at top left, #1d4ed8 0%, #020617 70%);
            color:#e5e7eb;
            border-radius: 18px;
            border: 1px solid rgba(148,163,184,0.45);
        }

        #login-card h1 { color:#f9fafb; }
        #login-card input,
        #login-card select {
            background: rgba(15,23,42,0.85);
            color:#e5e7eb;
            border-color:#334155;
        }
        #login-card input::placeholder {
            color:#9ca3af;
        }
        #login-card label {
            color:#cbd5f5;
        }

        /* HISOBOT blokidagi kichik jadval */
        .report-block {
            font-size: 13px;
        }
        .report-block p {
            margin: 2px 0;
        }
        .report-block ul {
            margin: 4px 0 0;
            padding-left: 18px;
        }
        .report-block li {
            margin: 1px 0;
        }

        /* MODAL – murojaat tafsilotlari & imzo */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal {
            background:#ffffff;
            border-radius: 18px;
            max-width: 880px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid rgba(148,163,184,0.4);
            box-shadow: 0 20px 50px rgba(15,23,42,0.45);
            display:flex;
            flex-direction:column;
        }

        .modal-header {
            padding: 10px 16px;
            border-bottom:1px solid #e5e7eb;
            display:flex;
            align-items:center;
            justify-content:space-between;
        }
        .modal-header h3 {
            margin:0;
        }
        .modal-body {
            padding: 10px 16px 14px;
            overflow-y:auto;
        }
        .modal-footer {
            padding: 10px 16px;
            border-top:1px solid #e5e7eb;
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:8px;
        }

        .detail-grid {
            display:grid;
            grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
            gap:12px;
            font-size: 13px;
        }

        .detail-block {
            border-radius: 12px;
            border:1px solid #e5e7eb;
            padding:8px 10px;
            background:#f9fafb;
        }

        .detail-row {
            display:flex;
            justify-content:space-between;
            gap:8px;
            margin-bottom:2px;
        }
        .detail-label {
            color:#6b7280;
        }
        .detail-value {
            font-weight:500;
        }

        .sign-item {
            border-bottom:1px dashed #e5e7eb;
            padding:4px 0;
            font-size:12px;
        }
        .sign-item:last-child {
            border-bottom:none;
        }
        .sign-role {
            font-weight:600;
        }
        .sign-meta {
            color:#6b7280;
            font-size:11px;
        }

        @media (max-width: 900px) {
            .grid-main {
                grid-template-columns: minmax(0, 1fr);
            }
            .detail-grid {
                grid-template-columns: minmax(0,1fr);
            }
        }
    </style>
</head>
<body>
<div class="layout">
    <!-- TOPBAR -->
    <div class="topbar">
        <div class="topbar-left">
            <div class="logo-circle">
                <!-- Shu fayl yoniga customs_logo.png qo'ysangiz, shu yerda chiqadi -->
                <img src="customs_logo.png" alt="Bojxona logotipi" onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=&quot;logo-fallback&quot;>BJ</span>';">
            </div>
            <div class="topbar-title">
                <span>O‘ZBEKISTON RESPUBLIKASI DAVLAT BOJXONA XIZMATI</span>
                <span>Aksiz markalari bilan bog‘liq murojaatlarni elektron ko‘rib chiqish tizimi (demo)</span>
            </div>
        </div>
        <div class="topbar-right">
    <!-- Foydalanuvchi badge (avatar + rol + ism/STIR) -->
    <button id="user-badge" class="user-badge hidden" type="button">
        <div class="user-badge-avatar" id="user-avatar-circle">U</div>
        <div class="user-badge-text">
            <div class="user-badge-role" id="topbar-role">Rol tanlanmagan</div>
            <div class="user-badge-name" id="topbar-user">Foydalanuvchi aniqlanmagan</div>
        </div>
        <div class="user-badge-caret">▾</div>
    </button>

    <!-- Ochiladigan menyu -->
    <div id="user-dropdown" class="user-dropdown hidden">
        <div class="user-dropdown-header">
            <div class="user-dropdown-avatar" id="user-dropdown-avatar">U</div>
            <div>
                <div class="user-dropdown-name" id="user-dropdown-name">Foydalanuvchi</div>
                <div class="user-dropdown-role" id="user-dropdown-role">Rol tanlanmagan</div>
            </div>
        </div>
        <div class="user-dropdown-body">
            <div class="user-dropdown-row">
                <span>STIR:</span>
                <span id="user-dropdown-inn">—</span>
            </div>
            <div class="user-dropdown-row">
                <span>Kabinet:</span>
                <span id="user-dropdown-kabinet">—</span>
            </div>
        </div>
        <div class="user-dropdown-footer">
            <button type="button" id="logout-btn-dropdown" class="btn btn-ghost btn-small" style="width:100%;">
                Chiqish
            </button>
        </div>
    </div>
</div>

    <div class="wrapper">
        <!-- LOGIN -->
        <div id="login-card" class="card">
            <h1>Aksiz markalari portali</h1>
            <p class="muted">
                Rolni tanlang va tizimga kiring. Hamma ma'lumotlar hozircha faqat brauzeringiz xotirasida
                (localStorage) saqlanadi – test va maket sifatida ishlatiladi.
            </p>
            <form id="login-form">
                <div class="row">
                    <div class="col-2">
                        <label for="login-role">Rol</label>
                        <select id="login-role">
                            <option value="tadbirkor">Tadbirkor</option>
                            <option value="hududiy">Hududiy bojxona</option>
                            <option value="qomita">Bojxona qo‘mitasi</option>
                            <option value="duk">Davlat belgisi DUK</option>
                            <option value="bank">Bank</option>
                        </select>
                    </div>
                    <div class="col-2">
                        <label for="login-inn">STIR (INN) – faqat Tadbirkor uchun</label>
                        <input id="login-inn" placeholder="Masalan: 207268193" />
                    </div>
                    <div class="col-2">
                        <label for="login-name">Foydalanuvchi / tashkilot nomi</label>
                        <input id="login-name" placeholder="Masalan: “Enter Engineering” yoki “Farg‘ona TJIB”" />
                    </div>
                </div>
                <div style="margin-top: 12px; display:flex;align-items:center;gap:8px;">
                    <button type="submit" class="btn btn-primary">
                        Tizimga kirish
                    </button>
                    <span class="muted">
                        Parol hozircha talab qilinmaydi (demo).
                    </span>
                </div>
            </form>
        </div>

        <!-- ASOSIY QISM -->
        <div id="app-card" class="hidden">
            <!-- Yuqori info -->
            <div class="card card-soft" style="margin-bottom:18px;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
                    <div>
                        <h2 id="app-title">Kabinet</h2>
                        <div class="muted" id="app-subtitle"></div>
                    </div>
                    <div style="text-align:right;">
                        <button type="button" id="logout-btn" class="btn btn-ghost btn-small">
                            Chiqish
                        </button>
                    </div>
                </div>
            </div>

            <!-- Asosiy grid: chapda forma / o'ngda hisobot -->
            <div class="grid-main">
                <!-- Yangi buyurtma – faqat Tadbirkor -->
                <div id="new-order-card" class="card">
                    <h3>Yangi aksiz markalari buyurtmasi (Tadbirkor)</h3>
                    <p class="muted">
                        Quyidagi ma'lumotlar 3566-sonli yo‘riqnomadagi buyurtma shakli tarkibiga mos ravishda
                        soddalashtirilgan (HS kodi, mahsulot tavsifi, markalar soni, qiymati, to‘lov ma'lumotlari va h.k.).
                    </p>
                    <form id="order-form">
                        <!-- 1. Asosiy ma'lumotlar -->
                        <div class="section-title">1. Asosiy ma'lumotlar</div>
                        <div class="row">
                            <div class="col-2">
                                <label for="product-type">Mahsulot turi</label>
                                <select id="product-type" required>
                                    <option value="alkogol">Alkogolli mahsulotlar</option>
                                    <option value="tamaki">Tamaki mahsulotlari</option>
                                </select>
                            </div>
                            <div class="col-2">
                                <label for="quarter">Hisobot davri (chorak)</label>
                                <select id="quarter">
                                    <option value="">Tanlang</option>
                                    <option value="2025-Q1">2025-Q1</option>
                                    <option value="2025-Q2" selected>2025-Q2</option>
                                    <option value="2025-Q3">2025-Q3</option>
                                    <option value="2025-Q4">2025-Q4</option>
                                </select>
                            </div>
                        </div>

                        <div class="row" style="margin-top:8px;">
                            <div class="col-2">
                                <label for="period-from">Rejalashtirilgan davr – boshlanish</label>
                                <input type="date" id="period-from" />
                            </div>
                            <div class="col-2">
                                <label for="period-to">Rejalashtirilgan davr – tugash</label>
                                <input type="date" id="period-to" />
                            </div>
                        </div>

                        <div class="row" style="margin-top:8px;">
                            <div class="col-2">
                                <label for="marks-qty">Aksiz markalari soni (dona)</label>
                                <input type="number" id="marks-qty" min="1" required />
                            </div>
                        </div>

                        <!-- 2. Mahsulot ma'lumotlari -->
                        <div class="section-title">2. Mahsulot ma'lumotlari (TIF TN, nomi va h.k.)</div>
                        <div class="row">
                            <div class="col-2">
                                <label for="hs-code">TIF TN (HS) kodi</label>
                                <input id="hs-code" placeholder="Masalan: 2204 21 940 0" />
                            </div>
                            <div class="col-2">
                                <label for="product-name">Mahsulot nomi</label>
                                <input id="product-name" placeholder="Masalan: Qizil vino 0,75 l" />
                            </div>
                        </div>

                        <div class="row" style="margin-top:8px;">
                            <div class="col-2">
                                <label for="unit-volume">Idish hajmi (masalan, 0.5 l)</label>
                                <input id="unit-volume" placeholder="0.5 l" />
                            </div>
                            <div class="col-2">
                                <label for="package-type">Qadoq turi</label>
                                <input id="package-type" placeholder="Shisha idish, quti va h.k." />
                            </div>
                            <div class="col-2">
                                <label for="mark-unit-value">1 dona aksiz markasi qiymati (so‘m)</label>
                                <input type="number" step="0.01" id="mark-unit-value" placeholder="Masalan: 50" />
                            </div>
                        </div>

                        <!-- 3. To'lov ma'lumotlari -->
                        <div class="section-title">3. To'lov hujjati ma'lumotlari</div>
                        <div class="row">
                            <div class="col-2">
                                <label for="payment-doc-no">To'lov hujjati raqami</label>
                                <input id="payment-doc-no" placeholder="Masalan: BK-2025/00123" />
                            </div>
                            <div class="col-2">
                                <label for="payment-doc-date">To'lov hujjati sanasi</label>
                                <input type="date" id="payment-doc-date" />
                            </div>
                            <div class="col-2">
                                <label for="payment-amount">To'lov summasi (so‘m)</label>
                                <input type="number" step="0.01" id="payment-amount" placeholder="Masalan: 1 500 000" />
                            </div>
                        </div>
                        <div class="row" style="margin-top:8px;">
                            <div class="col-2">
                                <label for="payment-bank">Bank nomi</label>
                                <input id="payment-bank" placeholder="Masalan: Xalq banki, Yangiariq filiali" />
                            </div>
                        </div>

                        <!-- 4. Izoh -->
                        <div class="section-title">4. Qo‘shimcha izoh</div>
                        <div>
                            <label for="order-comment">Izoh (ixtiyoriy)</label>
                            <textarea id="order-comment"
                                      placeholder="Masalan: “Yiliga rejalashtirilgan ishlab chiqarish hajmi bo‘yicha aksiz markalari buyurtirilmoqda”..."></textarea>
                        </div>

                        <!-- Yuborish -->
                        <div style="margin-top:12px;display:flex;align-items:center;gap:8px;">
                            <button type="submit" class="btn btn-primary">
                                Bojxona organiga yuborish (demo)
                            </button>
                            <span class="muted" id="order-status-msg"></span>
                        </div>
                    </form>
                </div>

                <!-- Hisobot blok -->
                <div id="reports-card" class="card">
                    <h3>Hisobot (joriy rol bo‘yicha)</h3>
                    <div id="report-content" class="report-block">
                        Hisobot uchun ma'lumot topilmadi.
                    </div>
                </div>
            </div>

            <!-- Buyurtmalar ro'yxati -->
            <div class="card">
                <h3>Buyurtmalar ro‘yxati</h3>
                <p class="muted" id="list-hint">
                    Jadval joriy rolga mos ravishda filtrlanadi. Har bir ustunda “Ko‘rish” tugmasi orqali
                    to‘liq ma'lumot va imzolar tarixini ko‘rish mumkin.
                </p>
                <div style="overflow:auto; max-height:440px;">
                    <table>
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>STIR</th>
                            <th>Buyurtma №</th>
                            <th>Sana</th>
                            <th>Turi</th>
                            <th>TIF TN</th>
                            <th>Markalar soni</th>
                            <th>Marka kodi</th>
                            <th>To'lov summasi</th>
                            <th>Holat</th>
                            <th>Amallar</th>
                        </tr>
                        </thead>
                        <tbody id="orders-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: murojaat tafsilotlari + imzolash -->
    <div id="detail-modal-backdrop" class="modal-backdrop hidden">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <h3 id="detail-title">Murojaat tafsiloti</h3>
                    <div class="muted" id="detail-subtitle"></div>
                </div>
                <button type="button" id="detail-close-btn" class="btn btn-ghost btn-small">
                    Yopish
                </button>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <!-- Sol tomonda buyurtma ma'lumotlari -->
                    <div>
                        <div class="detail-block">
                            <h4>Asosiy ma'lumotlar</h4>
                            <div class="detail-row">
                                <span class="detail-label">STIR:</span>
                                <span class="detail-value" id="detail-inn"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Tadbirkor:</span>
                                <span class="detail-value" id="detail-entrepreneur"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Mahsulot turi:</span>
                                <span class="detail-value" id="detail-product-type"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Hisobot davri:</span>
                                <span class="detail-value" id="detail-quarter"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Davr:</span>
                                <span class="detail-value" id="detail-period"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Holat:</span>
                                <span class="detail-value" id="detail-status"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Marka kodi:</span>
                                <span class="detail-value" id="detail-marka-code"></span>
                            </div>
                        </div>

                        <div class="detail-block" style="margin-top:8px;">
                            <h4>Mahsulot ma'lumotlari</h4>
                            <div class="detail-row">
                                <span class="detail-label">TIF TN:</span>
                                <span class="detail-value" id="detail-hs-code"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Mahsulot nomi:</span>
                                <span class="detail-value" id="detail-product-name"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Idish hajmi:</span>
                                <span class="detail-value" id="detail-unit-volume"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Qadoq turi:</span>
                                <span class="detail-value" id="detail-package-type"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Marka soni:</span>
                                <span class="detail-value" id="detail-marks-qty"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">1 dona narxi:</span>
                                <span class="detail-value" id="detail-mark-unit-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Umumiy qiymat:</span>
                                <span class="detail-value" id="detail-total-excise"></span>
                            </div>
                        </div>

                        <div class="detail-block" style="margin-top:8px;">
                            <h4>To'lov ma'lumotlari</h4>
                            <div class="detail-row">
                                <span class="detail-label">To'lov hujjati:</span>
                                <span class="detail-value" id="detail-payment-doc"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">To'lov summasi:</span>
                                <span class="detail-value" id="detail-payment-amount"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Bank:</span>
                                <span class="detail-value" id="detail-payment-bank"></span>
                            </div>
                        </div>

                        <div class="detail-block" style="margin-top:8px;">
                            <h4>Izoh</h4>
                            <div class="detail-row">
                                <span class="detail-value" id="detail-comment"></span>
                            </div>
                        </div>
                    </div>

                    <!-- O'ng tomonda imzolar va imzolash formasi -->
                    <div>
                        <div class="detail-block">
                            <h4>Imzolar tarixi</h4>
                            <div id="detail-signatures-list">
                                Hozircha imzolar mavjud emas.
                            </div>
                        </div>

                        <div id="detail-sign-form-block" class="detail-block" style="margin-top:8px;">
                            <h4>Imzolash (joriy rol)</h4>
                            <p class="muted" style="margin-top:0;">
                                Bu bo‘lim Tadbirkor rolidan tashqari barcha rollar uchun mo‘ljallangan.
                                Imzo qo‘yilganda foydalanuvchi F.I.Sh, rol va sana qayd etiladi.
                            </p>
                            <div style="margin-bottom:6px;">
                                <label for="detail-sign-fio">F.I.Sh</label>
                                <input id="detail-sign-fio" placeholder="Masalan: Xudoyberdiyev Xudoyberdi Xudoyberdiyevich" />
                            </div>
                            <div style="margin-bottom:6px;">
                                <label for="detail-sign-comment">Izoh (ixtiyoriy)</label>
                                <textarea id="detail-sign-comment" placeholder="Masalan: “Buyurtma ma'lumotlari to‘liq tekshirildi”..."></textarea>
                            </div>
                            <button type="button" id="detail-sign-btn" class="btn btn-primary btn-small">
                                Imzolash
                            </button>
                            <span id="detail-sign-msg" class="muted"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <span class="muted" id="detail-footer-meta"></span>
                <button type="button" id="detail-close-btn-bottom" class="btn btn-ghost btn-small">
                    Yopish
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    // --- localStorage kalitlari ---
    const STORAGE_KEY_ORDERS = "aksiz_orders_portal_v1";
    const STORAGE_KEY_MARKA = "aksiz_marka_codes_portal_v1";

    // --- global holat ---
    let orders = loadOrders();
    let markaCodes = loadMarkaCodes();

    let currentInn = null;
    let currentName = null;
    let currentRole = "tadbirkor";
    let currentDetailOrderId = null;

    const ROLE_LABELS = {
        tadbirkor: "Tadbirkor",
        hududiy: "Hududiy bojxona",
        qomita: "Bojxona qo‘mitasi",
        duk: "Davlat belgisi DUK",
        bank: "Bank"
    };

    // Statuslar: jarayon bosqichlari
    const STATUS_META = {
        new: {
            label: "Yangi (tadbirkor yuborgan)",
            badgeClass: "badge-new"
        },
        hud_approved: {
            label: "Hududiy bojxona tasdiqlagan",
            badgeClass: "badge-review"
        },
        hud_rejected: {
            label: "Hududiy bojxona rad etgan",
            badgeClass: "badge-rejected"
        },
        committee_approved: {
            label: "Qo‘mita tasdiqlagan",
            badgeClass: "badge-approved"
        },
        committee_rejected: {
            label: "Qo‘mita rad etgan",
            badgeClass: "badge-rejected"
        },
        duk_assigned: {
            label: "DUK marka ajratgan",
            badgeClass: "badge-bank"
        },
        bank_paid: {
            label: "Bank to‘lovni tasdiqlagan",
            badgeClass: "badge-approved"
        },
        completed: {
            label: "Yakunlangan",
            badgeClass: "badge-approved"
        }
    };

    // Har bir rol qaysi statuslarga o'zgartira oladi
    const ROLE_STATUS_OPTIONS = {
        tadbirkor: [], // faqat ko'radi, imzo qo'ymaydi
        hududiy: ["new", "hud_approved", "hud_rejected"],
        qomita: ["hud_approved", "committee_approved", "committee_rejected"],
        duk: ["committee_approved", "duk_assigned", "completed"],
        bank: ["duk_assigned", "bank_paid", "completed"]
    };

    // --- localStorage funksiyalari ---
    function loadOrders() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY_ORDERS);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
            console.error("Ordersni o'qishda xato:", e);
            return [];
        }
    }

    function saveOrders(list) {
        try {
            localStorage.setItem(STORAGE_KEY_ORDERS, JSON.stringify(list));
        } catch (e) {
            console.error("Ordersni yozishda xato:", e);
        }
    }

    function loadMarkaCodes() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY_MARKA);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
            console.error("Marka kodlarini o'qishda xato:", e);
            return [];
        }
    }

    function saveMarkaCodes(list) {
        try {
            localStorage.setItem(STORAGE_KEY_MARKA, JSON.stringify(list));
        } catch (e) {
            console.error("Marka kodlarini yozishda xato:", e);
        }
    }

    // --- yordamchi funksiyalar ---
    function $(id) {
        return document.getElementById(id);
    }

    function formatDate(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        if (isNaN(d)) return iso;
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
    }

    function formatDateTime(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        if (isNaN(d)) return iso;
        return d.toLocaleString("uz-UZ");
    }

    function nowIso() {
        return new Date().toISOString();
    }

    function generateOrderNo() {
        const year = new Date().getFullYear();
        const maxId = orders.reduce((max, o) => (o.id > max ? o.id : max), 0);
        const newId = maxId + 1;
        return {
            id: newId,
            orderNo: `AM-${year}/${String(newId).padStart(5, "0")}`
        };
    }

    function getYearSuffix(year) {
        const y = parseInt(year, 10);
        if (Number.isNaN(y)) return "";
        return String(y).slice(-2);
    }

    function parseNumber(val) {
        if (val == null || val === "") return null;
        const n = parseFloat(String(val).replace(",", "."));
        if (Number.isNaN(n)) return null;
        return n;
    }

    // Har bir STIR + yil + mahsulot turi bo'yicha ALBATTA bitta kod
    // Alkogol: 5 xonali (yy + 3 xonali tartib raqam)
    // Tamaki:  4 xonali (yy + 2 xonali tartib raqam)
    function getOrCreateMarkaCode(inn, year, productType) {
        if (!inn) return null;
        const y = parseInt(year, 10);
        if (Number.isNaN(y)) return null;

        let rec = markaCodes.find((c) => c.inn === inn && c.year === y);
        if (!rec) {
            rec = {
                inn: inn,
                year: y,
                alkoCode: null,
                tobCode: null
            };
            markaCodes.push(rec);
        }

        const yearSuffix = getYearSuffix(y);
        let code = null;

        if (productType === "alkogol") {
            if (rec.alkoCode) {
                return rec.alkoCode;
            }
            const usedNums = markaCodes
                .filter((c) => c.year === y && c.alkoCode)
                .map((c) => parseInt(c.alkoCode.slice(2), 10))
                .filter((n) => !Number.isNaN(n));
            const next = usedNums.length ? Math.max(...usedNums) + 1 : 1;
            const numericPart = String(next).padStart(3, "0");
            code = yearSuffix + numericPart;
            rec.alkoCode = code;
        } else if (productType === "tamaki") {
            if (rec.tobCode) {
                return rec.tobCode;
            }
            const usedNums = markaCodes
                .filter((c) => c.year === y && c.tobCode)
                .map((c) => parseInt(c.tobCode.slice(2), 10))
                .filter((n) => !Number.isNaN(n));
            const next = usedNums.length ? Math.max(...usedNums) + 1 : 1;
            const numericPart = String(next).padStart(2, "0");
            code = yearSuffix + numericPart;
            rec.tobCode = code;
        }

        saveMarkaCodes(markaCodes);
        return code;
    }

    // --- LOGIN LOGIKA ---
    const loginForm = $("login-form");
    const loginCard = $("login-card");
    const appCard = $("app-card");
    const appTitle = $("app-title");
    const appSubtitle = $("app-subtitle");
    const logoutBtn = $("logout-btn");
    const newOrderCard = $("new-order-card");
    const listHint = $("list-hint");
    const reportContent = $("report-content");
    const topbarRole = $("topbar-role");
    const topbarUser = $("topbar-user");

    loginForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const roleVal = $("login-role").value;
        const innVal = $("login-inn").value.trim();
        const nameVal = $("login-name").value.trim() || "Foydalanuvchi";

        currentRole = roleVal;

        if (roleVal === "tadbirkor") {
            if (!innVal) {
                alert("Tadbirkor sifatida kirish uchun STIR (INN) kiritish majburiy.");
                return;
            }
            currentInn = innVal;
            currentName = nameVal || "Tadbirkor";
        } else {
            currentInn = null;
            currentName = nameVal || ROLE_LABELS[roleVal];
        }

        loginCard.classList.add("hidden");
        appCard.classList.remove("hidden");

        const roleTitle = ROLE_LABELS[currentRole] || "Kabinet";
        appTitle.textContent = roleTitle + " kabineti";
        appSubtitle.textContent =
            currentRole === "tadbirkor"
                ? `${currentInn} – ${currentName} (Tadbirkor)`
                : `${roleTitle} – ${currentName}`;

        topbarRole.textContent = roleTitle;
        topbarUser.textContent =
            currentRole === "tadbirkor"
                ? `${currentInn} – ${currentName}`
                : currentName;

        if (currentRole === "tadbirkor") {
            newOrderCard.classList.remove("hidden");
            listHint.textContent =
                "Faqat ushbu STIR bo‘yicha buyurtmalar ko‘rsatilmoqda.";
        } else {
            newOrderCard.classList.add("hidden");
            listHint.textContent =
                "Jadval joriy roldagi tegishli buyurtmalarni ko‘rsatmoqda. Murojaatni 'Ko‘rish' orqali ichiga kirib, imzolash mumkin.";
        }

        renderOrdersForCurrent();
    });

    logoutBtn.addEventListener("click", () => {
        currentInn = null;
        currentName = null;
        currentRole = "tadbirkor";
        $("login-inn").value = "";
        $("login-name").value = "";
        $("login-role").value = "tadbirkor";
        topbarRole.textContent = "Rol tanlanmagan";
        topbarUser.textContent = "Foydalanuvchi aniqlanmagan";
        appCard.classList.add("hidden");
        loginCard.classList.remove("hidden");
    });

    // --- Yangi buyurtma (faqat Tadbirkor) ---
    const orderForm = $("order-form");
    const orderStatusMsg = $("order-status-msg");

    orderForm.addEventListener("submit", (e) => {
        e.preventDefault();

        if (currentRole !== "tadbirkor" || !currentInn) {
            alert("Yangi buyurtma faqat Tadbirkor uchun.");
            return;
        }

        const productType = $("product-type").value;
        const quarter = $("quarter").value;
        const periodFrom = $("period-from").value || null;
        const periodTo = $("period-to").value || null;
        const marksQtyVal = $("marks-qty").value;

        const hsCode = $("hs-code").value.trim();
        const productName = $("product-name").value.trim();
        const unitVolume = $("unit-volume").value.trim();
        const packageType = $("package-type").value.trim();
        const markUnitValueVal = $("mark-unit-value").value;

        const paymentDocNo = $("payment-doc-no").value.trim();
        const paymentDocDate = $("payment-doc-date").value || null;
        const paymentAmountVal = $("payment-amount").value;
        const paymentBank = $("payment-bank").value.trim();

        const marks = parseInt(marksQtyVal, 10);
        if (Number.isNaN(marks) || marks <= 0) {
            orderStatusMsg.textContent = "Xato: Aksiz markalari soni noto‘g‘ri.";
            orderStatusMsg.className = "error-msg";
            return;
        }

        const markUnitValue = parseNumber(markUnitValueVal);
        const paymentAmount = parseNumber(paymentAmountVal);
        const totalExciseValue =
            markUnitValue != null ? markUnitValue * marks : null;

        const { id, orderNo } = generateOrderNo();
        const now = nowIso();

        const order = {
            id,
            orderNo,
            inn: currentInn,
            entrepreneurName: currentName,
            productType,
            quarter: quarter || null,
            periodFrom,
            periodTo,
            marksQty: marks,

            hsCode: hsCode || null,
            productName: productName || null,
            unitVolume: unitVolume || null,
            packageType: packageType || null,
            markUnitValue: markUnitValue,
            totalExciseValue: totalExciseValue,

            paymentDocNo: paymentDocNo || null,
            paymentDocDate: paymentDocDate,
            paymentAmount: paymentAmount,
            paymentBank: paymentBank || null,

            status: "new",
            markaCode: null,        // DUK bosqichida to'ldiriladi
            comment: ($("order-comment").value || "").trim() || null,
            createdAt: now,
            updatedAt: now,

            // Imzolar ro'yxati
            signatures: []
        };

        orders.push(order);
        saveOrders(orders);

        orderStatusMsg.textContent = "Buyurtma muvaffaqiyatli saqlandi (demo).";
        orderStatusMsg.className = "ok-msg";
        orderForm.reset();
        $("product-type").value = "alkogol";

        renderOrdersForCurrent();
    });

    // --- Buyurtmalarni ko'rsatish va hisobot ---
    function renderOrdersForCurrent() {
        let list = orders;

        if (currentRole === "tadbirkor" && currentInn) {
            list = list.filter((o) => o.inn === currentInn);
        }

        if (currentRole === "hududiy") {
            list = list.filter((o) =>
                ["new", "hud_approved", "hud_rejected"].includes(o.status || "new")
            );
        } else if (currentRole === "qomita") {
            list = list.filter((o) =>
                ["hud_approved", "committee_approved", "committee_rejected"].includes(
                    o.status || "new"
                )
            );
        } else if (currentRole === "duk") {
            list = list.filter((o) =>
                ["committee_approved", "duk_assigned", "completed"].includes(
                    o.status || "new"
                )
            );
        } else if (currentRole === "bank") {
            list = list.filter((o) =>
                ["duk_assigned", "bank_paid", "completed"].includes(o.status || "new")
            );
        }

        renderOrders(list);
        renderReport(list);
    }

    function renderOrders(list) {
        const tbody = $("orders-tbody");
        tbody.innerHTML = "";

        if (!Array.isArray(list) || list.length === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 11;
            td.textContent = "Hozircha buyurtmalar mavjud emas.";
            td.style.textAlign = "center";
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
        }

        list
            .slice()
            .sort((a, b) => b.id - a.id)
            .forEach((o) => {
                const tr = document.createElement("tr");
                const statusKey = o.status || "new";
                const meta = STATUS_META[statusKey] || {
                    label: statusKey,
                    badgeClass: "badge-new"
                };

                const markaText = o.markaCode || "-";

                let paymentText = "-";
                if (o.paymentAmount != null) {
                    paymentText = o.paymentAmount.toLocaleString("uz-UZ", {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                }

                tr.innerHTML = `
                    <td>${o.id}</td>
                    <td>${o.inn || "-"}</td>
                    <td>${o.orderNo}</td>
                    <td>${formatDate(o.createdAt)}</td>
                    <td>${o.productType === "alkogol" ? "Alkogol" : "Tamaki"}</td>
                    <td>${o.hsCode || ""}</td>
                    <td>${(o.marksQty || 0).toLocaleString("uz-UZ")}</td>
                    <td>${markaText}</td>
                    <td>${paymentText}</td>
                    <td><span class="badge ${meta.badgeClass}">${meta.label}</span></td>
                `;

                const tdAction = document.createElement("td");
                tdAction.style.whiteSpace = "nowrap";

                const viewBtn = document.createElement("button");
                viewBtn.textContent = "Ko‘rish";
                viewBtn.className = "btn btn-ghost btn-small";
                viewBtn.addEventListener("click", () => openOrderDetail(o.id));
                tdAction.appendChild(viewBtn);

                const opts = ROLE_STATUS_OPTIONS[currentRole] || [];
                if (opts.length > 0) {
                    const select = document.createElement("select");
                    select.style.fontSize = "11px";
                    select.style.marginLeft = "4px";

                    if (statusKey && !opts.includes(statusKey)) {
                        const optCurrent = document.createElement("option");
                        optCurrent.value = statusKey;
                        optCurrent.textContent = meta.label + " (hozirgi)";
                        select.appendChild(optCurrent);
                    }

                    opts.forEach((code) => {
                        const m = STATUS_META[code] || { label: code };
                        const opt = document.createElement("option");
                        opt.value = code;
                        opt.textContent = m.label;
                        if (code === statusKey) opt.selected = true;
                        select.appendChild(opt);
                    });

                    const saveBtn = document.createElement("button");
                    saveBtn.textContent = "Holatni saqlash";
                    saveBtn.className = "btn btn-ghost btn-small";
                    saveBtn.style.marginLeft = "4px";
                    saveBtn.addEventListener("click", () => {
                        const newStatus = select.value;
                        updateOrderStatus(o.id, newStatus);
                    });

                    tdAction.appendChild(select);
                    tdAction.appendChild(saveBtn);
                }

                tr.appendChild(tdAction);
                tbody.appendChild(tr);
            });
    }

    function renderReport(list) {
        if (!reportContent) return;

        if (!Array.isArray(list) || list.length === 0) {
            reportContent.innerHTML = "Hisobot uchun ma'lumot mavjud emas.";
            return;
        }

        const totalOrders = list.length;
        const totalMarks = list.reduce(
            (s, o) => s + (o.marksQty || 0),
            0
        );
        const totalPayment = list.reduce(
            (s, o) => s + (o.paymentAmount || 0),
            0
        );
        const totalExcise = list.reduce(
            (s, o) => s + (o.totalExciseValue || 0),
            0
        );

        const byStatus = {};
        list.forEach((o) => {
            const st = o.status || "new";
            byStatus[st] = (byStatus[st] || 0) + 1;
        });

        let html = "";
        html += `<p>Jami buyurtmalar: <b>${totalOrders}</b>.</p>`;
        html += `<p>Jami aksiz markalari soni: <b>${totalMarks.toLocaleString("uz-UZ")}</b>.</p>`;
        html += `<p>Buyurtmalar bo‘yicha to‘lov hujjatlarida ko‘rsatilgan umumiy summa: <b>${totalPayment.toLocaleString(
            "uz-UZ",
            { minimumFractionDigits: 2, maximumFractionDigits: 2 }
        )}</b> so‘m.</p>`;

        if (totalExcise > 0) {
            html += `<p>Markalar bo‘yicha hisoblangan umumiy qiymat (soni × 1 dona narxi): <b>${totalExcise.toLocaleString(
                "uz-UZ",
                { minimumFractionDigits: 2, maximumFractionDigits: 2 }
            )}</b> so‘m.</p>`;
        }

        html += `<p>Holatlar bo‘yicha taqsimot:</p><ul>`;
        Object.keys(byStatus).forEach((k) => {
            const meta = STATUS_META[k] || { label: k };
            html += `<li>${meta.label}: <b>${byStatus[k]}</b> ta</li>`;
        });
        html += `</ul>`;

        if (currentRole === "tadbirkor" && currentInn) {
            html += `<p class="muted">Ushbu hisobot faqat STIR <b>${currentInn}</b> bo‘yicha hisoblangan.</p>`;
        } else {
            const roleTitle = ROLE_LABELS[currentRole] || currentRole;
            html += `<p class="muted">Hisobot joriy rol: <b>${roleTitle}</b> kesimida shakllantirilgan (demo).</p>`;
        }

        reportContent.innerHTML = html;
    }

    function updateOrderStatus(id, newStatus) {
        const idx = orders.findIndex((o) => o.id === id);
        if (idx === -1) {
            alert("Buyurtma topilmadi.");
            return;
        }
        const order = orders[idx];

        const allowed = ROLE_STATUS_OPTIONS[currentRole] || [];
        if (!allowed.includes(newStatus)) {
            alert(
                "Bu holatni \"" +
                (ROLE_LABELS[currentRole] || currentRole) +
                "\" o‘zgartira olmaydi."
            );
            return;
        }

        // DUK bosqichida marka kodi ajratish
        if (currentRole === "duk" && newStatus === "duk_assigned") {
            let year = null;
            if (order.quarter && order.quarter.includes("-")) {
                const parts = order.quarter.split("-");
                year = parseInt(parts[0], 10);
            } else if (order.createdAt) {
                year = new Date(order.createdAt).getFullYear();
            }
            const code = getOrCreateMarkaCode(order.inn, year, order.productType);
            order.markaCode = code;
        }

        order.status = newStatus;
        order.updatedAt = nowIso();
        saveOrders(orders);
        renderOrdersForCurrent();

        if (currentDetailOrderId === id) {
            openOrderDetail(id);
        }
    }

    // --- MODAL: murojaat tafsilotlari + imzolash ---
    const detailBackdrop = $("detail-modal-backdrop");
    const detailCloseBtn = $("detail-close-btn");
    const detailCloseBtnBottom = $("detail-close-btn-bottom");

    const detailTitle = $("detail-title");
    const detailSubtitle = $("detail-subtitle");
    const detailInn = $("detail-inn");
    const detailEntrepreneur = $("detail-entrepreneur");
    const detailProductType = $("detail-product-type");
    const detailQuarter = $("detail-quarter");
    const detailPeriod = $("detail-period");
    const detailStatus = $("detail-status");
    const detailMarkaCode = $("detail-marka-code");

    const detailHsCode = $("detail-hs-code");
    const detailProductName = $("detail-product-name");
    const detailUnitVolume = $("detail-unit-volume");
    const detailPackageType = $("detail-package-type");
    const detailMarksQty = $("detail-marks-qty");
    const detailMarkUnitValue = $("detail-mark-unit-value");
    const detailTotalExcise = $("detail-total-excise");

    const detailPaymentDoc = $("detail-payment-doc");
    const detailPaymentAmount = $("detail-payment-amount");
    const detailPaymentBank = $("detail-payment-bank");

    const detailComment = $("detail-comment");
    const detailSignaturesList = $("detail-signatures-list");
    const detailFooterMeta = $("detail-footer-meta");

    const detailSignFormBlock = $("detail-sign-form-block");
    const detailSignFio = $("detail-sign-fio");
    const detailSignComment = $("detail-sign-comment");
    const detailSignBtn = $("detail-sign-btn");
    const detailSignMsg = $("detail-sign-msg");

    function openOrderDetail(id) {
        const order = orders.find((o) => o.id === id);
        if (!order) {
            alert("Buyurtma topilmadi.");
            return;
        }
        currentDetailOrderId = id;

        const meta = STATUS_META[order.status || "new"] || {
            label: order.status || "Noma'lum",
            badgeClass: "badge-new"
        };

        detailTitle.textContent = `Buyurtma: ${order.orderNo}`;
        detailSubtitle.textContent = `ID: ${order.id}, yaratilgan sana: ${formatDate(order.createdAt)}`;
        detailInn.textContent = order.inn || "-";
        detailEntrepreneur.textContent = order.entrepreneurName || "-";
        detailProductType.textContent = order.productType === "alkogol" ? "Alkogol mahsulotlari" : "Tamaki mahsulotlari";
        detailQuarter.textContent = order.quarter || "-";
        detailPeriod.textContent = (order.periodFrom ? formatDate(order.periodFrom) : "?") +
            " – " +
            (order.periodTo ? formatDate(order.periodTo) : "?");
        detailStatus.textContent = meta.label;
        detailMarkaCode.textContent = order.markaCode || "-";

        detailHsCode.textContent = order.hsCode || "";
        detailProductName.textContent = order.productName || "";
        detailUnitVolume.textContent = order.unitVolume || "";
        detailPackageType.textContent = order.packageType || "";
        detailMarksQty.textContent = (order.marksQty || 0).toLocaleString("uz-UZ");
        detailMarkUnitValue.textContent =
            order.markUnitValue != null
                ? order.markUnitValue.toLocaleString("uz-UZ", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " so‘m"
                : "-";
        detailTotalExcise.textContent =
            order.totalExciseValue != null
                ? order.totalExciseValue.toLocaleString("uz-UZ", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " so‘m"
                : "-";

        const docNo = order.paymentDocNo || "-";
        const docDate = order.paymentDocDate ? formatDate(order.paymentDocDate) : "-";
        detailPaymentDoc.textContent = `${docNo} (${docDate})`;
        detailPaymentAmount.textContent =
            order.paymentAmount != null
                ? order.paymentAmount.toLocaleString("uz-UZ", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " so‘m"
                : "-";
        detailPaymentBank.textContent = order.paymentBank || "-";

        detailComment.textContent = order.comment || "Izoh kiritilmagan.";

        const signs = order.signatures || [];
        if (!signs.length) {
            detailSignaturesList.innerHTML = "Hozircha imzolar mavjud emas.";
        } else {
            detailSignaturesList.innerHTML = "";
            signs.forEach((s) => {
                const div = document.createElement("div");
                div.className = "sign-item";
                const roleTitle = ROLE_LABELS[s.role] || s.role;
                div.innerHTML = `
                    <div class="sign-role">${roleTitle}</div>
                    <div>${s.fio || "(F.I.Sh ko'rsatilmagan)"}</div>
                    <div class="sign-meta">${formatDateTime(s.signedAt)} – ${s.comment || "Izohsiz"}</div>
                `;
                detailSignaturesList.appendChild(div);
            });
        }

        detailFooterMeta.textContent =
            `Yaratilgan: ${formatDateTime(order.createdAt)}. Oxirgi o‘zgartirish: ${formatDateTime(order.updatedAt)}.`;

        if (currentRole === "tadbirkor") {
            detailSignFormBlock.classList.add("hidden");
        } else {
            detailSignFormBlock.classList.remove("hidden");
        }
        detailSignFio.value = "";
        detailSignComment.value = "";
        detailSignMsg.textContent = "";
        detailSignMsg.className = "muted";

        detailBackdrop.classList.remove("hidden");
    }

    function closeOrderDetail() {
        detailBackdrop.classList.add("hidden");
        currentDetailOrderId = null;
    }

    detailCloseBtn.addEventListener("click", closeOrderDetail);
    detailCloseBtnBottom.addEventListener("click", closeOrderDetail);
    detailBackdrop.addEventListener("click", (e) => {
        if (e.target === detailBackdrop) {
            closeOrderDetail();
        }
    });

    detailSignBtn.addEventListener("click", () => {
        if (!currentDetailOrderId) return;
        if (currentRole === "tadbirkor") {
            detailSignMsg.textContent = "Imzolash faqat bojxona/bank rollari uchun.";
            detailSignMsg.className = "error-msg";
            return;
        }

        const fio = detailSignFio.value.trim();
        const comment = detailSignComment.value.trim();

        if (!fio) {
            detailSignMsg.textContent = "F.I.Sh ni kiritish majburiy.";
            detailSignMsg.className = "error-msg";
            return;
        }

        const idx = orders.findIndex((o) => o.id === currentDetailOrderId);
        if (idx === -1) {
            detailSignMsg.textContent = "Buyurtma topilmadi.";
            detailSignMsg.className = "error-msg";
            return;
        }

        const order = orders[idx];
        if (!Array.isArray(order.signatures)) {
            order.signatures = [];
        }

        order.signatures.push({
            role: currentRole,
            fio: fio,
            comment: comment || null,
            signedAt: nowIso()
        });

        order.updatedAt = nowIso();
        saveOrders(orders);

        detailSignMsg.textContent = "Imzo muvaffaqiyatli qo‘yildi.";
        detailSignMsg.className = "ok-msg";

        renderOrdersForCurrent();
        openOrderDetail(order.id);
    });

    // sahifa yuklanganda ma'lumotlar localStorage'dan yuklanadi,
    // lekin foydalanuvchi login qilmaguncha ko'rsatilmaydi.
</script>
</body>
</html>

